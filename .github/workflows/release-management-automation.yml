name: Automate some steps of release management
# No git flow handled here

on:
  milestone:
    types: [created]

jobs:
  get-release-version:
    runs-on: ubuntu-latest
    outputs:
      is-patch: ${{ steps.check-patch.outputs.is-patch }}
    env:
      MILESTONES_VERSION: ${{ github.event.milestone.title }}
    steps:
      - uses: actions/checkout@v3
      - name: Check if this release is a patch release only
        id: check-patch
        run: |
          echo version: $MILESTONES_VERSION
          if [[ $MILESTONES_VERSION =~ ^v[0-9]+\.[0-9]+\.0$ ]]; then
            echo 'This is NOT a patch release'
            echo ::set-output name=is-patch::false
          elif [[ $MILESTONES_VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo 'This is a patch release'
            echo ::set-output name=is-patch::true
          else
            echo 'Not a valid format of release, check the Milestones title.'
            echo 'Should be vX.Y.Z'
            exit 1
          fi

  create-roadmap-issue:
    needs: get-release-version
    # Create the roadmap issue if the release is not only a patch release
    if: needs.get-release-version.outputs.is-patch == 'false'
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      MILESTONES_VERSION: ${{ github.event.milestone.title }}
      ISSUE_TEMPLATE: roadmap-issue-template.md
    steps:
      - uses: actions/checkout@v3
      - run: echo ${{ needs.get-release-version.outputs.is-patch }}
      - name: Download the issue template
        run: curl -s https://raw.githubusercontent.com/meilisearch/core-team/main/issue-templates/roadmap-issue.md > $ISSUE_TEMPLATE
      - name: Replace all <<version>> occurences $MILESTONES_VERSION in the template
        run: |
          sed -i "s/<<version>>/$MILESTONES_VERSION/g" $ISSUE_TEMPLATE
          ls -la
          cat roadmap-issue-template.md
      - name: Create the issue
        run: |
          gh issue create \
            --title 'Write release'
            --label 'epic,impacts docs, impacts integrations, impacts cloud' \
            --body $(cat $ISSUE_TEMPLATE) \
            --milestone $MILESTONES_VERSION \
            --assignee curquiza

# create-roadmap-issue:
# create-label:
# labalize-issues: when closing -> open an issue
